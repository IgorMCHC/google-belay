<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
    <script src="../belay/caps.js"></script>
    <script type="text/javascript">
      var log = function(text) {
        $("<li></li>").text(text).appendTo('#transcript');
      };
      
      $(function(){
        var channel = new MessageChannel();         log("Constructed channel");
        var tunnel = new CapTunnel(channel.port1);  log("Constructed tunnel");
        var server = new CapServer();               log("Constructed server");
        tunnel.setLocalResolver(function(instID) {
          return server.publicInterface;
        });
        var cap1 = server.grant(function(v) { 
          log("cap1 invoked with: " + v);
          return v + 10;
        });                                         log("Constructed grant");
        window.opener.postMessage(
          { ser: cap1.serialize(), instID: server.instanceID }, 
          [channel.port2], '*');                    log("Posted ready message");        
      });
    </script>
  </head>
  <body>
    <h1>Transcript</h1>
    <ol id="transcript"></ol>
  </body>
</html>
